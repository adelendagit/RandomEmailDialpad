<!DOCTYPE html>
<html>
<head>
  <title>Search Emails</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 1em;
      background: #f9f9f9;
    }

    input, button {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
    }

    .chat-thread {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px 0;
    }

    .chat-message {
      display: flex;
      width: 100%;
    }

    .chat-message.sent {
      justify-content: flex-end;
    }

    .chat-message.received {
      justify-content: flex-start;
    }

    .chat-bubble {
      background: #f1f1f1;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 65%;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-size: 0.95em;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .chat-message.sent .chat-bubble {
      background: #edf4fc;
      color: #111;
      border-bottom-right-radius: 4px;
      border-bottom-left-radius: 18px;
    }


    .chat-message.received .chat-bubble {
      background: #f1f1f1;
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 18px;
    }

    .chat-meta {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 6px;
    }

    h1, h2 {
      text-align: center;
    }

    form {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <h1>Search Emails Involving a Contact</h1>
  <form method="POST" action="/search-emails">
    <input
      type="email"
      name="email"
      placeholder="someone@example.com"
      required
      value="<%= typeof query !== 'undefined' ? query : '' %>" />

    <input
      type="text"
      name="subject"
      placeholder="(optional) Subject contains..."
      value="<%= typeof subject !== 'undefined' ? subject : '' %>" />

    <button type="submit">Search</button>
  </form>
  <% if (results) { %>
    <% if (results.length === 0) { %>
      <p>No recent emails found involving "<%= query %>".</p>
    <% } else { %>
      <h2>Conversation with <%= query %></h2>
      <div class="chat-thread">
        <% results.forEach(msg => {
          const isSent = msg.from?.emailAddress?.address.toLowerCase() === user.email.toLowerCase();
          const side = isSent ? 'sent' : 'received';
          const date = new Date(msg.receivedDateTime || msg.sentDateTime).toLocaleString();
        %>
          <div class="chat-message <%= side %>" data-id="<%= msg.id %>">
            <div class="chat-bubble">
              <div class="chat-meta">
                <small><%= date %></small>
              </div>
              <strong><%= msg.subject || 'No subject' %></strong><br />
              <small>From: <%= msg.from?.emailAddress?.address %></small><br />
              <small>To: <%= msg.toRecipients?.map(r => r.emailAddress?.address).join(', ') %></small>
              <div class="chat-body" style="margin-top: 10px;">
                <%- msg.body?.content || '<em>(no message body)</em>' %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  <% } %>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Collect IDs of alreadyâ€rendered messages
  const existing = new Set(
    Array.from(document.querySelectorAll('.chat-message'))
         .map(el => el.getAttribute('data-id'))
  );

  // Post email+subject to expand endpoint
  fetch('/search-emails/expand', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      email: '<%= query %>',
      subject: '<%= typeof subject !== "undefined" ? subject : "" %>'
    })
  })
  .then(res => res.json())
  .then(extra => {
    const thread = document.querySelector('.chat-thread');
    extra.forEach(msg => {
      // Skip ones we already have
      if (existing.has(msg.id)) return;

      // Determine sent vs received
      const isSent = msg.from?.emailAddress?.address.toLowerCase() === '<%= user.email.toLowerCase() %>';
      const side = isSent ? 'sent' : 'received';
      const date = new Date(msg.receivedDateTime || msg.sentDateTime).toLocaleString();

      // Build bubble element
      const wrapper = document.createElement('div');
      wrapper.className = `chat-message ${side}`;
      wrapper.setAttribute('data-id', msg.id);

      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble';

      bubble.innerHTML = `
        <div class="chat-meta"><small>${date}</small></div>
        <strong>${msg.subject || 'No subject'}</strong><br/>
        <small>From: ${msg.from.emailAddress.address}</small><br/>
        <small>To: ${msg.toRecipients.map(r=>r.emailAddress.address).join(', ')}</small>
        <div class="chat-body" style="margin-top:10px;">
          ${msg.body.content}
        </div>
      `;

      wrapper.appendChild(bubble);
      thread.appendChild(wrapper);
    });
  })
  .catch(err => console.error('Expand failed:', err));
});
</script>


</html>
