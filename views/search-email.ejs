<!DOCTYPE html>
<html>
<head>
  <title>Search Emails</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 1em;
      background: #f9f9f9;
    }

    input, button {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
    }

    .chat-thread {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px 0;
    }

    .chat-message {
      display: flex;
      width: 100%;
    }

    .chat-message.sent {
      justify-content: flex-end;
    }

    .chat-message.received {
      justify-content: flex-start;
    }

    .chat-bubble {
      background: #f1f1f1;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 65%;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-size: 0.95em;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .chat-message.sent .chat-bubble {
      background: #edf4fc;
      color: #111;
      border-bottom-right-radius: 4px;
      border-bottom-left-radius: 18px;
    }


    .chat-message.received .chat-bubble {
      background: #f1f1f1;
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 18px;
    }

    .chat-meta {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 6px;
    }

    h1, h2 {
      text-align: center;
    }

    form {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <h1>Search Emails Involving a Contact</h1>
  <form method="POST" action="/search-emails">
    <input
      type="email"
      name="email"
      placeholder="someone@example.com"
      required
      value="<%= typeof query !== 'undefined' ? query : '' %>" />

    <input
      type="text"
      name="subject"
      placeholder="(optional) Subject contains..."
      value="<%= typeof subject !== 'undefined' ? subject : '' %>" />

    <button type="submit">Search</button>
  </form>
  <% if (results) { %>
    <% if (results.length === 0) { %>
      <p>No recent emails found involving "<%= query %>".</p>
    <% } else { %>
      <h2>Conversation with <%= query %></h2>
      <div class="chat-thread">
        <% results.forEach(msg => {
          const isSent = msg.from?.emailAddress?.address.toLowerCase() === user.email.toLowerCase();
          const side = isSent ? 'sent' : 'received';
          const date = new Date(msg.receivedDateTime || msg.sentDateTime).toLocaleString();
        %>
          <div class="chat-message <%= side %>">
            <div class="chat-bubble">
              <div class="chat-meta">
                <small><%= date %></small>
              </div>
              <strong><%= msg.subject || 'No subject' %></strong><br />
              <small>From: <%= msg.from?.emailAddress?.address %></small><br />
              <small>To: <%= msg.toRecipients?.map(r => r.emailAddress?.address).join(', ') %></small>
              <div class="chat-body" style="margin-top: 10px;">
                <%- msg.body?.content || '<em>(no message body)</em>' %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  <% } %>
</body>
      <script>
  window.addEventListener('DOMContentLoaded', () => {
    fetch('/search-emails/expand', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        email: '<%= query %>',
        subject: '<%= typeof subject !== "undefined" ? subject : "" %>'
      })
    })
    .then(res => res.json())
    .then(extraMessages => {
      console.log('Fetched extra messages:', extraMessages.length);

      // You can now:
      // 1. Append them to the DOM
      // 2. Replace existing content
      // 3. Show a "Load more" button

      // OPTIONAL: Trigger a UI update (you can build this out)
    })
    .catch(err => {
      console.error('Background fetch failed:', err);
    });
  });
</script>

</html>
